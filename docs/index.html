<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NovaRAG</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .wrap { max-width: 720px; margin: auto; }
    textarea { width: 100%; height: 140px; }
    .row { margin: 0.5rem 0; }
    .btn { padding: 0.6rem 1rem; cursor: pointer; }
    #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 0.75rem; border-radius: 8px; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>NovaRAG</h1>

    <div class="row">
      <label>Gateway URL</label><br/>
      <input type="text" id="gw" value="https://novarag-gatewaygateway-dotnet.onrender.com" style="width:100%">
    </div>

    <div class="row">
      <label>Document ID</label><br/>
      <input type="text" id="docId" placeholder="e.g. litreview-2025" style="width:100%">
    </div>

    <div class="row">
      <label>Paste Text</label><br/>
      <textarea id="textInput" placeholder="Paste text here..."></textarea>
    </div>

    <div class="row">
      <label>Or Upload PDF/TXT</label><br/>
      <input type="file" id="fileInput" accept=".pdf,.txt">
    </div>

    <div class="row">
      <button class="btn" onclick="doIngest()">Ingest</button>
    </div>

    <div id="log"></div>
  </div>

<script>
let token = null;

async function getToken(gateway) {
  if (token) return token;
  const r = await fetch(`${gateway}/api/auth/token`, {
    headers: { Authorization: "Basic " + btoa("demo:demo") }
  });
  if (!r.ok) throw new Error("Auth failed: " + (await r.text()));
  const j = await r.json();
  token = j.token;
  return token;
}

function log(msg) {
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
}

async function doIngest() {
  const gateway = document.getElementById("gw").value.trim();
  const docId = document.getElementById("docId").value.trim();
  const text = document.getElementById("textInput").value.trim();
  const file = document.getElementById("fileInput").files[0];
  const out = document.getElementById("log");
  out.textContent = "";

  if (!gateway) return log("❌ Please provide Gateway URL");
  if (!docId)    return log("❌ Please provide Document ID");

  try {
    const tk = await getToken(gateway);

    let r;
    if (file) {
      log("⏳ Uploading file...");
      const form = new FormData();
      form.append("doc_id", docId);
      form.append("file", file);
      r = await fetch(`${gateway}/api/ingest-file`, {
        method: "POST",
        headers: { Authorization: `Bearer ${tk}` },
        body: form
      });
    } else if (text) {
      log("⏳ Sending text...");
      r = await fetch(`${gateway}/api/ingest-text`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${tk}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ doc_id: docId, text, chunk_size: 700 })
      });
    } else {
      return log("❌ Paste text or choose a file.");
    }

    if (!r.ok) {
      const t = await r.text();
      return log("❌ Ingestion failed: " + t);
    }
    const j = await r.json();
    log("✅ Ingested batches: " + (j.batches ?? 1));
  } catch (e) {
    log("❌ Error: " + e.message);
  }
}
</script>
</body>
</html>
